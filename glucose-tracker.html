<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glucose Tracker - GenieSugar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fb;
            color: #333;
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-header svg {
            flex-shrink: 0;
        }

        .sidebar-header span {
            font-size: 20px;
            font-weight: 700;
            color: #1565A6;
        }

        .sidebar-nav {
            padding: 20px 0;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s;
            margin: 5px 10px;
            border-radius: 10px;
        }

        .nav-item:hover {
            background: #f0f7ff;
            color: #1565A6;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #1565A6 0%, #2196F3 100%);
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
            min-height: 100vh;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-size: 32px;
            color: #1565A6;
            margin-bottom: 5px;
        }

        .dashboard-header p {
            color: #666;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1565A6 0%, #2196F3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(21, 101, 166, 0.3);
        }

        .btn-outline {
            background: white;
            border: 2px solid #e0e0e0;
            color: #666;
        }

        .btn-outline:hover {
            border-color: #1565A6;
            color: #1565A6;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Current Status Card */
        .current-status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-main {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-icon svg {
            width: 40px;
            height: 40px;
            stroke-width: 2;
            color: #1565A6;
        }

        .status-info {
            flex: 1;
        }

        .status-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            display: block;
        }

        .status-value {
            font-size: 42px;
            font-weight: 700;
            color: #1565A6;
            margin-bottom: 5px;
        }

        .status-time {
            color: #999;
            font-size: 14px;
        }

        .status-stats {
            display: flex;
            gap: 40px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item span {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-item strong {
            font-size: 24px;
            color: #1565A6;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 18px;
            color: #333;
        }

        .card-body {
            padding: 25px;
            height: 300px;
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 10px;
        }

        .time-btn {
            padding: 6px 15px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: all 0.3s;
        }

        .time-btn.active {
            background: #1565A6;
            color: white;
            border-color: #1565A6;
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .stat-value-large {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #999;
            font-size: 13px;
        }

        /* Table */
        .table-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            font-size: 18px;
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8fafc;
            padding: 15px 25px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            border-bottom: 1px solid #eee;
        }

        .data-table td {
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        /* Badge Styles */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-danger {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .badge-warning {
            background: #FFF8E1;
            color: #FF8F00;
        }

        .badge-success {
            background: #E8F5E9;
            color: #2E7D32;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1565A6;
            box-shadow: 0 0 0 3px rgba(21, 101, 166, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .notification-error {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
        }

        .notification-info {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }

            .sidebar-header span {
                display: none;
            }

            .nav-item span {
                display: none;
            }

            .main-content {
                margin-left: 70px;
                padding: 20px;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .status-stats {
                flex-direction: column;
                gap: 15px;
            }

            .current-status-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .card-body {
                height: 250px;
            }

            .header-actions {
                flex-direction: column;
                width: 100%;
            }

            .header-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <svg width="40" height="40" viewBox="0 0 40 40">
                <circle cx="20" cy="20" r="18" fill="#1565A6"/>
                <circle cx="30" cy="30" r="6" fill="#FF6B6B"/>
            </svg>
            <span>GenieSugar</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="patient-dashboard.html" class="nav-item">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="14" height="14" rx="2"/>
                    <path d="M3 9h18"/>
                    <path d="M9 21v-6"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="glucose-tracker.html" class="nav-item active">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
                <span>Glucose Tracker</span>
            </a>
            <a href="food-logger.html" class="nav-item">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>
                    <path d="M2 12h20"/>
                    <path d="M12 2v20"/>
                </svg>
                <span>Food Log</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="dashboard-header">
            <div>
                <h1>Glucose Tracker ðŸ“Š</h1>
                <p>Monitor your blood sugar levels</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="syncDexcom()">
                    <i class="fas fa-sync-alt"></i>
                    Sync Dexcom
                </button>
                <button class="btn btn-primary" onclick="showAddReadingModal()">
                    <i class="fas fa-plus"></i>
                    Add Reading
                </button>
            </div>
        </header>

        <!-- Current Status -->
        <div class="current-status-card">
            <div class="status-main">
                <div class="status-icon" id="statusIcon">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="status-info">
                    <span class="status-label">Current Glucose</span>
                    <h2 class="status-value" id="currentGlucose">-- mg/dL</h2>
                    <span class="status-time" id="lastUpdate">--</span>
                </div>
            </div>
            <div class="status-stats">
                <div class="stat-item">
                    <span>7-Day Average</span>
                    <strong id="avgGlucose">-- mg/dL</strong>
                </div>
                <div class="stat-item">
                    <span>Time in Range</span>
                    <strong id="timeInRange">--%</strong>
                </div>
                <div class="stat-item">
                    <span>Readings Today</span>
                    <strong id="readingsToday">0</strong>
                </div>
            </div>
        </div>

        <!-- Glucose Chart -->
        <div class="card">
            <div class="card-header">
                <h3>Glucose Trend</h3>
                <div class="time-selector">
                    <button class="time-btn active" onclick="loadChartData(1)">24H</button>
                    <button class="time-btn" onclick="loadChartData(7)">7D</button>
                    <button class="time-btn" onclick="loadChartData(14)">14D</button>
                    <button class="time-btn" onclick="loadChartData(30)">30D</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="glucoseTrendChart"></canvas>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Readings Below Range</h4>
                <div class="stat-value-large" style="color: #FF6B6B;" id="lowReadings">0</div>
                <p>&lt; 70 mg/dL</p>
            </div>
            <div class="stat-card">
                <h4>Readings in Range</h4>
                <div class="stat-value-large" style="color: #4CAF50;" id="normalReadings">0</div>
                <p>70-180 mg/dL</p>
            </div>
            <div class="stat-card">
                <h4>Readings Above Range</h4>
                <div class="stat-value-large" style="color: #FFC107;" id="highReadings">0</div>
                <p>&gt; 180 mg/dL</p>
            </div>
            <div class="stat-card">
                <h4>Glucose Variability</h4>
                <div class="stat-value-large" style="color: #2196F3;" id="variability">0</div>
                <p>Standard Deviation</p>
            </div>
        </div>

        <!-- Recent Readings Table -->
        <div class="table-card">
            <div class="table-header">
                <h3>Recent Readings</h3>
                <button class="btn btn-sm btn-outline" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export CSV
                </button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Reading (mg/dL)</th>
                        <th>Context</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="readingsTable">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add Reading Modal -->
    <div id="addReadingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Glucose Reading</h3>
                <button onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Glucose Reading (mg/dL) *</label>
                    <input type="number" id="glucoseValue" placeholder="120" min="20" max="600">
                </div>
                <div class="form-group">
                    <label>Context</label>
                    <select id="context">
                        <option value="fasting">Fasting</option>
                        <option value="before_meal">Before Meal</option>
                        <option value="after_meal">After Meal</option>
                        <option value="bedtime">Bedtime</option>
                        <option value="random">Random</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="readingNotes" rows="3" placeholder="Any notes about this reading..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitReading()">Save Reading</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data storage (in a real app, this would come from an API)
        let glucoseData = {
            readings: [],
            chart: null
        };

        // Mock data for demonstration
        function generateMockData() {
            const mockData = [];
            const now = new Date();
            
            // Generate data for the last 30 days
            for (let i = 0; i < 120; i++) {
                const date = new Date();
                date.setHours(now.getHours() - i * 6); // Every 6 hours
                
                // Generate realistic glucose values (mostly in range)
                let value;
                const random = Math.random();
                
                if (random < 0.05) { // 5% low
                    value = Math.floor(Math.random() * (69 - 40) + 40);
                } else if (random < 0.15) { // 10% high
                    value = Math.floor(Math.random() * (250 - 181) + 181);
                } else { // 85% in range
                    value = Math.floor(Math.random() * (180 - 70) + 70);
                }
                
                const contexts = ['fasting', 'before_meal', 'after_meal', 'bedtime', 'random'];
                const notes = ['', 'After exercise', 'Before lunch', 'Feeling dizzy', ''];
                
                mockData.push({
                    id: i + 1,
                    value: value,
                    timestamp: date.toISOString(),
                    context: contexts[Math.floor(Math.random() * contexts.length)],
                    notes: notes[Math.floor(Math.random() * notes.length)]
                });
            }
            
            return mockData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Initialize with mock data
        document.addEventListener('DOMContentLoaded', function() {
            glucoseData.readings = generateMockData();
            loadChartData(7);
            updateDisplay();
        });

        function getStatus(value) {
            if (value < 70) return { 
                text: 'Low', 
                class: 'danger', 
                color: '#FF6B6B',
                icon: 'fas fa-arrow-down'
            };
            if (value > 180) return { 
                text: 'High', 
                class: 'warning', 
                color: '#FFC107',
                icon: 'fas fa-arrow-up'
            };
            return { 
                text: 'Normal', 
                class: 'success', 
                color: '#4CAF50',
                icon: 'fas fa-check'
            };
        }

        function updateDisplay() {
            if (glucoseData.readings.length === 0) return;
            
            // Update current reading
            const latest = glucoseData.readings[0];
            document.getElementById('currentGlucose').textContent = `${latest.value} mg/dL`;
            
            const status = getStatus(latest.value);
            const statusIcon = document.getElementById('statusIcon');
            statusIcon.innerHTML = `<i class="${status.icon}"></i>`;
            statusIcon.style.background = `linear-gradient(135deg, ${status.color}20 0%, ${status.color}10 100%)`;
            
            const timeAgo = formatTimeAgo(new Date(latest.timestamp));
            document.getElementById('lastUpdate').textContent = `Last updated ${timeAgo}`;
            
            // Calculate statistics
            const last7Days = glucoseData.readings.filter(r => 
                (new Date() - new Date(r.timestamp)) <= 7 * 24 * 60 * 60 * 1000
            );
            
            if (last7Days.length > 0) {
                const values = last7Days.map(r => r.value);
                const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
                document.getElementById('avgGlucose').textContent = `${avg} mg/dL`;
                
                const inRange = values.filter(v => v >= 70 && v <= 180).length;
                const timeInRange = ((inRange / values.length) * 100).toFixed(0);
                document.getElementById('timeInRange').textContent = `${timeInRange}%`;
                
                document.getElementById('readingsToday').textContent = glucoseData.readings.filter(r => 
                    new Date(r.timestamp).toDateString() === new Date().toDateString()
                ).length;
                
                // Update stats grid
                const allValues = glucoseData.readings.map(r => r.value);
                document.getElementById('lowReadings').textContent = allValues.filter(v => v < 70).length;
                document.getElementById('normalReadings').textContent = allValues.filter(v => v >= 70 && v <= 180).length;
                document.getElementById('highReadings').textContent = allValues.filter(v => v > 180).length;
                
                // Calculate standard deviation
                const mean = allValues.reduce((a, b) => a + b) / allValues.length;
                const variance = allValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / allValues.length;
                const stdDev = Math.sqrt(variance).toFixed(1);
                document.getElementById('variability').textContent = stdDev;
            }
            
            // Update table
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('readingsTable');
            tbody.innerHTML = glucoseData.readings.slice(0, 10).map(reading => {
                const date = new Date(reading.timestamp);
                const status = getStatus(reading.value);
                
                return `
                    <tr>
                        <td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        <td><strong>${reading.value}</strong></td>
                        <td>${reading.context.replace('_', ' ').toUpperCase()}</td>
                        <td><span class="badge badge-${status.class}">${status.text}</span></td>
                        <td>${reading.notes || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadChartData(days) {
            // Update active button
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter data for selected time range
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            
            const filteredData = glucoseData.readings.filter(reading => 
                new Date(reading.timestamp) >= cutoffDate
            ).slice(0, 100); // Limit to 100 points for performance
            
            updateChart(filteredData, days);
        }

        function updateChart(data, days) {
            const ctx = document.getElementById('glucoseTrendChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (glucoseData.chart) {
                glucoseData.chart.destroy();
            }
            
            // Format labels based on time range
            let labels;
            if (days === 1) {
                labels = data.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            } else if (days <= 14) {
                labels = data.map(d => new Date(d.timestamp).toLocaleDateString([], {month: 'short', day: 'numeric'}));
            } else {
                labels = data.map(d => new Date(d.timestamp).toLocaleDateString([], {month: 'short', day: 'numeric'}));
            }
            
            // Create chart
            glucoseData.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Glucose Level (mg/dL)',
                        data: data.map(d => d.value),
                        borderColor: '#1565A6',
                        backgroundColor: 'rgba(21, 101, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: data.map(d => {
                            const status = getStatus(d.value);
                            return status.color;
                        }),
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Glucose: ${context.parsed.y} mg/dL`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            min: 40,
                            max: 250,
                            grid: {
                                color: '#f0f0f0'
                            },
                            title: {
                                display: true,
                                text: 'mg/dL'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            tension: 0.3
                        }
                    }
                }
            });
        }

        function showAddReadingModal() {
            document.getElementById('addReadingModal').style.display = 'flex';
            document.getElementById('glucoseValue').focus();
        }

        function closeModal() {
            document.getElementById('addReadingModal').style.display = 'none';
            document.getElementById('glucoseValue').value = '';
            document.getElementById('readingNotes').value = '';
        }

        function submitReading() {
            const value = document.getElementById('glucoseValue').value;
            const context = document.getElementById('context').value;
            const notes = document.getElementById('readingNotes').value;
            
            if (!value || value < 20 || value > 600) {
                showNotification('Please enter a valid glucose value (20-600 mg/dL)', 'error');
                return;
            }
            
            // Add new reading
            const newReading = {
                id: glucoseData.readings.length + 1,
                value: parseInt(value),
                timestamp: new Date().toISOString(),
                context: context,
                notes: notes
            };
            
            // Add to beginning of array (most recent first)
            glucoseData.readings.unshift(newReading);
            
            // Update display
            updateDisplay();
            
            // Update chart with current time range
            const activeDays = document.querySelector('.time-btn.active').textContent;
            let days;
            switch(activeDays) {
                case '24H': days = 1; break;
                case '7D': days = 7; break;
                case '14D': days = 14; break;
                default: days = 30;
            }
            loadChartData(days);
            
            // Close modal and show success message
            closeModal();
            showNotification('Glucose reading added successfully!', 'success');
        }

        function syncDexcom() {
            showNotification('Syncing with Dexcom...', 'info');
            
            // Simulate API call delay
            setTimeout(() => {
                // Add mock synced data
                const syncedCount = Math.floor(Math.random() * 5) + 3;
                const now = new Date();
                
                for (let i = 0; i < syncedCount; i++) {
                    const date = new Date();
                    date.setMinutes(now.getMinutes() - i * 15);
                    
                    const newReading = {
                        id: glucoseData.readings.length + i + 1,
                        value: Math.floor(Math.random() * (180 - 70) + 70),
                        timestamp: date.toISOString(),
                        context: 'random',
                        notes: 'Synced from Dexcom'
                    };
                    
                    glucoseData.readings.unshift(newReading);
                }
                
                // Sort by date (most recent first)
                glucoseData.readings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                updateDisplay();
                showNotification(`${syncedCount} new readings synced from Dexcom!`, 'success');
            }, 1500);
        }

        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + ["Date,Time,Reading (mg/dL),Context,Notes"]
                .concat(glucoseData.readings.map(reading => {
                    const date = new Date(reading.timestamp);
                    return [
                        date.toLocaleDateString(),
                        date.toLocaleTimeString(),
                        reading.value,
                        reading.context.replace('_', ' '),
                        reading.notes || ''
                    ].join(',');
                }))
                .join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `glucose_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data exported successfully!', 'success');
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addReadingModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Handle Enter key in modal
        document.getElementById('glucoseValue').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitReading();
            }
        });
    </script>
</body>
</html>